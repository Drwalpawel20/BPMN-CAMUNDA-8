<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">

    <title>Wniosek Parkingowy</title>

    <link rel="stylesheet" href="https://unpkg.com/@bpmn-io/form-js@0.7.2/dist/assets/form-js.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <style>
        #form {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        #message-area.error-message {
            background-color: #fdd;
            border: 1px solid #c00;
            padding: 10px;
            margin-bottom: 20px;
            color: #c00;
            font-weight: bold;
            border-radius: 4px;
        }

        .fjs-form-field-error {
            color: #c00 !important; /
            font-size: 0.9em;
            margin-top: 5px;
        }
    </style>
</head>

<body>
<div id="message-area"><span id="status-message"></span></div>
<div id="form"></div>

<script type="application/form-schema" src="form333.json"></script>

<script src="https://unpkg.com/@bpmn-io/form-js@0.10.0/dist/form-viewer.umd.js"></script>

<script>

    function translateValidationErrors() {
        $('.fjs-form-field-error').each(function() {
            let errorText = $(this).text().trim();

            // Tłumaczenie błędu wymaganego pola
            if (errorText === 'Field is required.') {
                $(this).text('Pole jest wymagane.');
            }
            // UWAGA: Tłumaczenia innych błędów (min/max length) mogą wymagać dodania tutaj.
        });
    }


    $.getJSON('form333.json', function(data) {
        const schema = data;
        const container = document.querySelector('#form');
        const messageArea = $('#message-area');
        const statusMessage = $('#status-message');

        FormViewer.createForm({
            container,
            schema
        }).then(function(form) {
            console.log(form);

            form.on('submit', event => {
                // 1. Walidacja: generuje błędy i je wyświetla
                const errors = form.validate();
                const isValid = Object.keys(errors).length === 0;

                // 2. Czyść komunikaty
                messageArea.removeClass('error-message');
                statusMessage.empty();

                // 3. Wstrzymaj i wyświetl błędy, jeśli walidacja nie przeszła
                if (!isValid) {
                    // Wyświetl ogólny komunikat na górze
                    messageArea.addClass('error-message');
                    statusMessage.html("Wysłanie formularza nie powiodło się! Proszę uzupełnić wszystkie wymagane pola.");

                    // Poczekaj, aż form-js wstawi błędy, a następnie je przetłumacz
                    setTimeout(translateValidationErrors, 50);

                    console.log('Walidacja nieudana. Wstrzymuję wysyłkę AJAX.');
                    return; // Blokuje wysyłkę AJAX (czyli kod IntelliJ się nie uruchomi)
                }

                // --- 4. KOD WYKONYWANY TYLKO PO PRAWIDŁOWEJ WALIDACJI ---
                console.log('Formularz poprawny. Wysyłam AJAX do serwera...');

                $.ajax("/start", {
                    data : JSON.stringify(event.data),
                    contentType : 'application/json',
                    type : 'POST',
                    success: function(data) {
                        form.reset();
                        messageArea.removeClass('error-message').addClass('success-message');
                        statusMessage.html("<b>Aplikacja zarejestrowana. Decyzja zostanie przekazana na podany adres email.</b>");
                    },
                    error: function(xhr, status, error) {
                        // Obsługa błędu serwera
                        messageArea.addClass('error-message');
                        statusMessage.html("Wystąpił błąd podczas komunikacji z serwerem. Spróbuj ponownie.");
                    }
                });
            });
        });
    });
</script>
</body>
</html>